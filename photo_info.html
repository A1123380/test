<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>照片資訊</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100%; width: 100%; 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #FFF9EB; 
            overflow-y: auto; 
        }

        .photo-header {
            width: 100%; height: 45vh; position: relative; background: #000;
        }
        .display-img { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .back-btn { 
            position: absolute; top: 20px; left: 20px; 
            font-size: 28px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
            cursor: pointer; z-index: 10;
        }

        .info-container { padding: 25px 20px; }
        .title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .photo-title { font-size: 28px; font-weight: bold; color: #333; flex: 1; }

        .detail-item { 
            font-size: 15px; color: #444; margin-bottom: 12px; line-height: 1.5; 
            word-break: break-all;
        }
        .detail-label { font-weight: bold; color: #666; margin-right: 8px; }

        /* 標籤小按鈕樣式 */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .tag-btn {
            background: #FFF0D1; color: #FF9800; padding: 6px 14px;
            border: 1.5px solid #FFB352; border-radius: 20px;
            font-size: 14px; font-weight: bold; white-space: nowrap;
        }

        .description-box {
            margin-top: 20px; border-top: 1px solid #ffeccc; padding-top: 15px;
        }
        .desc-label { font-weight: bold; color: #333; margin-bottom: 8px; display: block; }
        .desc-input {
            width: 100%; min-height: 100px; background: transparent; border: none;
            font-size: 16px; color: #555; line-height: 1.6; outline: none; resize: none;
        }

        .map-section { margin-top: 25px; cursor: pointer; }
        .mini-map-container {
            height: 200px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #miniMap { height: 100%; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 15px; padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
            background: #FFF9EB; text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .save-btn {
            background: #FFB352; color: white; padding: 14px 40px;
            border: none; border-radius: 30px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(255,179,82,0.3);
        }
    </style>
</head>
<body>
    <div class="photo-header">
        <div class="back-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></div>
        <img id="mainImg" class="display-img" src="">
    </div>

    <div class="info-container">
        <div class="title-row">
            <div class="photo-title" id="pTitle">載入中...</div>
        </div>

        <div class="detail-item">
            <span class="detail-label">拍攝時間：</span><span id="pTime"></span>
        </div>
        <div class="detail-item">
            <span class="detail-label">座標：</span><span id="pCoords"></span>
        </div>
        <div class="detail-item">
            <span class="detail-label">檔案名稱：</span><span id="pFileName"></span>
        </div>
        <div class="detail-item">
            <span class="detail-label">標籤：</span>
            <div class="tags-container" id="pTags"></div>
        </div>
        <div class="detail-item">
            <span class="detail-label">地點：</span><span id="pAddress">未知地點</span>
        </div>

        <div class="description-box">
            <div class="desc-label">描述</div>
            <textarea class="desc-input" id="pDesc" placeholder="寫點什麼..."></textarea>
        </div>

        <div class="map-section" onclick="returnToMainMap()">
            <div class="mini-map-container" id="miniMap"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="save-btn" onclick="saveAndBack()">儲存並返回</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let photo = null;
        const isNew = localStorage.getItem('temp_photo_data') !== null;

        // 餐廳資料（請補齊你的餐廳座標與名稱）
        const restaurants = [
            { name: "Luffy Cafe 相簿", pos: [22.7333, 120.2847], tags: ["#寵物友善", "#狗狗"] },
            { name: "沐沐MUMU 茶飲", pos: [22.70350854455539, 120.30130446507042], tags: ["#寵物友善"] },
            { name: "Bon appétit 葩那貝蒂", pos: [22.736657810967653, 120.32909822442647], tags: ["#寵物友善"] },
            // ... 其他餐廳
        ];

        window.onload = () => {
            photo = isNew ? JSON.parse(localStorage.getItem('temp_photo_data')) : {};

            if (!photo || !photo.src) {
                alert("無法載入照片");
                history.back();
                return;
            }

            // 自動偵測最近餐廳
            let minDistance = Infinity;
            let detectedRestaurant = "未知地點";
            let detectedTags = ["#寵物友善"];

            restaurants.forEach(res => {
                const dist = Math.hypot(res.pos[0] - photo.lat, res.pos[1] - photo.lng);
                if (dist < 0.01 && dist < minDistance) {
                    minDistance = dist;
                    detectedRestaurant = res.name;
                    detectedTags = res.tags;
                }
            });

            // 更新畫面
            document.getElementById('mainImg').src = photo.src;
            document.getElementById('pTitle').textContent = detectedRestaurant;
            document.getElementById('pTime').textContent = `${photo.date} ${photo.time || ''}`;
            document.getElementById('pCoords').textContent = `${photo.lat.toFixed(6)}, ${photo.lng.toFixed(6)}`;
            document.getElementById('pFileName').textContent = photo.name || '未知檔案';
            document.getElementById('pAddress').textContent = detectedRestaurant;

            // 標籤渲染為小按鈕
            const tagsContainer = document.getElementById('pTags');
            tagsContainer.innerHTML = '';
            detectedTags.forEach(tag => {
                const btn = document.createElement('div');
                btn.className = 'tag-btn';
                btn.textContent = tag;
                tagsContainer.appendChild(btn);
            });

            document.getElementById('pDesc').value = photo.description || '';

            // 寫回餐廳屬性
            photo.restaurant = detectedRestaurant;

            // 自動建立餐廳相簿
            if (detectedRestaurant !== "未知地點") {
                let custom = JSON.parse(localStorage.getItem('custom_albums')) || [];
                if (!custom.includes(detectedRestaurant)) {
                    custom.push(detectedRestaurant);
                    localStorage.setItem('custom_albums', JSON.stringify(custom));
                }
            }

            // 小地圖
            const miniMap = L.map('miniMap', { zoomControl: false, attributionControl: false })
                .setView([photo.lat, photo.lng], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(miniMap);
            L.marker([photo.lat, photo.lng]).addTo(miniMap);

            // 若為新照片，存入正式資料庫
            if (isNew) {
                let allPhotos = JSON.parse(localStorage.getItem('all_photos')) || [];
                allPhotos.push(photo);
                localStorage.setItem('all_photos', JSON.stringify(allPhotos));
                localStorage.removeItem('temp_photo_data');
            }

            window.currentPhoto = photo;
        };

        function saveAndBack() {
            if (!photo) return;

            photo.description = document.getElementById('pDesc').value.trim();

            let allPhotos = JSON.parse(localStorage.getItem('all_photos')) || [];
            const index = allPhotos.findIndex(p => p.id === photo.id);
            if (index !== -1) allPhotos[index] = photo;
            else allPhotos.push(photo);

            localStorage.setItem('all_photos', JSON.stringify(allPhotos));
            history.back();
        }

        function returnToMainMap() {
            localStorage.setItem('highlight_photo', JSON.stringify(window.currentPhoto));
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
