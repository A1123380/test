<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>相簿內容</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100%; width: 100%; 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #FFF9EB; 
            overflow: hidden; 
        }

        .container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }

        /* 頂部導覽 */
        .top-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; padding-top: calc(env(safe-area-inset-top) + 10px);
        }
        .action-btn { 
            background-color: rgba(255, 255, 255, 0.9); border-radius: 20px; 
            padding: 8px 18px; color: #333; text-decoration: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 14px; font-weight: bold;
        }

        /* 照片網格區 */
        .photo-grid-wrapper { flex: 1; overflow-y: auto; padding: 5px; }
        .photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; }
        .photo-item { position: relative; padding-top: 100%; background-color: #eee; cursor: pointer; }
        .photo-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* 選取狀態 */
        .selection-overlay { 
            position: absolute; top: 5px; right: 5px; width: 22px; height: 22px; 
            border-radius: 50%; border: 2px solid white; background: rgba(0,0,0,0.2); 
            display: flex; justify-content: center; align-items: center; color: white; font-size: 11px;
        }
        .photo-item.selected .selection-overlay { background-color: #007AFF; }
        .photo-item.selected .photo-img { opacity: 0.7; }

        /* 底部操作列 (沿用 old_index 風格) */
        .bottom-nav {
            height: calc(65px + env(safe-area-inset-bottom));
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px env(safe-area-inset-bottom) 30px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .bottom-icon-btn { font-size: 26px; color: #444; cursor: pointer; }
        .count-text { font-size: 16px; font-weight: bold; color: #333; }

        /* 橘色搜尋/標籤彈窗 (依照 photo-search.jpg) */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 1000; 
            backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: #FFF0D1; width: 85%; max-width: 350px; border-radius: 24px; 
            padding: 30px; position: relative; text-align: center;
        }
        .modal-input { 
            width: 100%; padding: 12px; border-radius: 12px; border: none; 
            background: #FFF9EB; margin: 10px 0 20px 0; font-size: 16px; 
        }
        .modal-confirm-btn { 
            width: 100%; padding: 14px; background: #FFB352; color: white; 
            border: none; border-radius: 15px; font-size: 18px; font-weight: bold; 
        }

        /* 搬移選單 (依照 photo-move.png) */
        .move-list { max-height: 200px; overflow-y: auto; text-align: left; }
        .move-item { padding: 15px; border-bottom: 1px solid #eee; color: #FF9800; font-weight: bold; }

        /* 下拉選單 */
        .dropdown { 
            position: absolute; right: 20px; top: 70px; background: white; 
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); 
            display: none; flex-direction: column; width: 160px; z-index: 500;
        }
        .dropdown-item { padding: 15px; display: flex; align-items: center; gap: 10px; font-size: 14px; border-bottom: 1px solid #f5f5f5; }
        .dropdown-item i { color: #FF9800; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-nav">
            <a href="photo_album.html" class="action-btn">上一頁</a>
            <div class="action-btn" id="moreBtn">...</div>
        </div>

        <div class="photo-grid-wrapper">
            <div id="albumTitle" style="padding: 10px 15px; font-weight: bold; font-size: 20px;">相簿名稱</div>
            <div class="photo-grid" id="photoGrid"></div>
        </div>

        <div class="bottom-nav">
            <div class="bottom-icon-btn" onclick="openSort()"><i class="fa-solid fa-arrow-up-z-a"></i></div>
            <div class="count-text" id="selectedText">已選取 0 張照片</div>
            <div class="bottom-icon-btn" onclick="openSearch()"><i class="fa-solid fa-magnifying-glass"></i></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div style="position: absolute; top: 15px; right: 15px; cursor: pointer;" onclick="closeModal()">✕</div>
            <h3 id="modalTitle">搜尋照片</h3>
            <div style="text-align: left; margin-top: 15px;">
                <label>名稱</label><input type="text" id="nameInput" class="modal-input">
                <label>標籤</label><input type="text" id="tagInput" class="modal-input">
            </div>
            <button class="modal-confirm-btn" id="modalConfirm">確定</button>
        </div>
    </div>

    <div class="modal-overlay" id="moveOverlay">
        <div class="modal-content" style="background: white;">
            <h3 style="margin-bottom: 20px;">選擇目標相簿</h3>
            <div class="move-list" id="albumMoveList"></div>
            <button onclick="closeMove()" style="margin-top: 15px; background: none; border: none; color: #666;">取消</button>
        </div>
    </div>

    <div class="dropdown" id="moreDropdown">
        <div class="dropdown-item" onclick="openTagModal()"><i class="fa-solid fa-tag"></i> 標籤功能</div>
        <div class="dropdown-item" onclick="openMove()"><i class="fa-solid fa-shuffle"></i> 搬移照片</div>
        <div class="dropdown-item" style="color: red;" onclick="deletePhotos()"><i class="fa-solid fa-trash"></i> 刪除照片</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentAlbum = urlParams.get('album') || 'default';
        let allPhotos = JSON.parse(localStorage.getItem('all_photos')) || [];
        
        document.getElementById('albumTitle').textContent = currentAlbum + " 相簿";

        function renderPhotos() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            // 如果不是 default，則過濾出該餐廳的照片
            const displayList = currentAlbum === 'default' 
                ? allPhotos 
                : allPhotos.filter(p => p.restaurant === currentAlbum);

            displayList.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `<img src="${photo.src}" class="photo-img"><div class="selection-overlay"></div>`;
                div.onclick = () => {
                    div.classList.toggle('selected');
                    updateCount();
                };
                // 點擊進入資訊頁 (長按或雙擊邏輯可在此擴充)
                div.ondblclick = () => {
                    localStorage.setItem('viewing_photo', JSON.stringify(photo));
                    window.location.href = 'photo_info.html';
                };
                grid.appendChild(div);
            });
        }

        function updateCount() {
            const selected = document.querySelectorAll('.photo-item.selected').length;
            document.getElementById('selectedText').textContent = `已選取 ${selected} 張照片`;
            const overlays = document.querySelectorAll('.photo-item.selected .selection-overlay');
            overlays.forEach((el, i) => el.textContent = i + 1);
        }

        // 選單與 Modal 邏輯
        document.getElementById('moreBtn').onclick = (e) => {
            e.stopPropagation();
            const dd = document.getElementById('moreDropdown');
            dd.style.display = dd.style.display === 'flex' ? 'none' : 'flex';
        };

        function openSearch() {
            document.getElementById('modalTitle').textContent = "搜尋照片";
            document.getElementById('modalConfirm').textContent = "搜尋";
            document.getElementById('modalOverlay').style.display = 'flex';
            document.getElementById('modalConfirm').onclick = () => { /* 實作過濾邏輯 */ closeModal(); };
        }

        function openTagModal() {
            document.getElementById('moreDropdown').style.display = 'none';
            document.getElementById('modalTitle').textContent = "批次設定標籤";
            document.getElementById('modalConfirm').textContent = "設定";
            document.getElementById('modalOverlay').style.display = 'flex';
            document.getElementById('modalConfirm').onclick = () => { /* 實作標籤寫入邏輯 */ closeModal(); };
        }

        function openMove() {
            document.getElementById('moreDropdown').style.display = 'none';
            const list = document.getElementById('albumMoveList');
            list.innerHTML = '';
            // 抓取現有餐廳相簿
            const restaurantNames = [...new Set(allPhotos.map(p => p.restaurant).filter(r => r))];
            restaurantNames.forEach(name => {
                const item = document.createElement('div');
                item.className = 'move-item';
                item.textContent = name;
                item.onclick = () => { alert(`已搬移至 ${name}`); closeMove(); };
                list.appendChild(item);
            });
            document.getElementById('moveOverlay').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        function closeMove() { document.getElementById('moveOverlay').style.display = 'none'; }
        window.onclick = () => { document.getElementById('moreDropdown').style.display = 'none'; };

        renderPhotos();
    </script>
</body>
</html>