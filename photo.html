<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>相簿內容</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100%; width: 100%; 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #FFF9EB; 
            overflow: hidden; 
        }

        .container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
        }

        /* 頂部導覽 */
        .top-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; padding-top: calc(env(safe-area-inset-top) + 10px);
            background: #FFF9EB;
            z-index: 10;
        }
        .back-btn { font-size: 24px; color: #333; cursor: pointer; }
        .album-name { font-size: 20px; font-weight: bold; color: #333; }
        .select-btn { 
            background-color: #8C8475; color: white; padding: 6px 16px; 
            border-radius: 20px; font-weight: bold; font-size: 14px; cursor: pointer;
        }

        /* 照片網格區 */
        .photo-grid-wrapper { 
            flex: 1; overflow-y: auto; padding: 5px; background: #FFF9EB; 
        }
        .photo-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; 
        }
        .photo-item { 
            position: relative; padding-top: 100%; background-color: #eee; cursor: pointer; 
        }
        .photo-img { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
        }
        
        /* 選取狀態 */
        .selection-overlay { 
            position: absolute; top: 5px; right: 5px; width: 22px; height: 22px; 
            border-radius: 50%; border: 2px solid white; background: rgba(0,0,0,0.2); 
            display: none; justify-content: center; align-items: center; color: white; font-size: 11px;
        }
        .photo-item.selected .selection-overlay { 
            display: flex; background-color: #FF9800; 
        }
        .photo-item.selected .photo-img { opacity: 0.7; }

        /* 空相簿提示 */
        .empty-album {
            grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #888;
            font-size: 18px;
        }

        /* 底部操作列 */
        .bottom-nav {
            height: calc(65px + env(safe-area-inset-bottom));
            background: rgba(255, 255, 255, 0.95);
            display: none; justify-content: space-around; align-items: center;
            padding: 0 30px env(safe-area-inset-bottom) 30px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .bottom-icon-btn { font-size: 26px; color: #444; cursor: pointer; }
        .count-text { font-size: 16px; font-weight: bold; color: #333; }

        /* 模態彈窗 */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 350px; border-radius: 20px;
            padding: 30px; text-align: center;
        }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .modal-input {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd;
            font-size: 16px; margin-bottom: 20px;
        }
        .modal-btn {
            background: #FFB352; color: white; padding: 14px; border-radius: 15px;
            border: none; font-size: 18px; font-weight: bold; width: 100%; cursor: pointer;
        }

        /* 搬移列表 */
        .move-list {
            max-height: 300px; overflow-y: auto; margin: 20px 0;
        }
        .move-item {
            padding: 14px; border-bottom: 1px solid #eee; text-align: left; cursor: pointer;
        }
        .move-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-nav">
            <div class="back-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></div>
            <div class="album-name" id="albumName">載入中...</div>
            <div class="select-btn" id="selectBtn">選取</div>
        </div>

        <div class="photo-grid-wrapper">
            <div class="photo-grid" id="photoGrid"></div>
        </div>

        <div class="bottom-nav" id="bottomNav">
            <div class="bottom-icon-btn" id="tagBtn"><i class="fa-solid fa-tag"></i></div>
            <div class="bottom-icon-btn" id="moveBtn"><i class="fa-solid fa-folder-open"></i></div>
            <div class="count-text" id="selectedText">已選取 0 張</div>
            <div class="bottom-icon-btn" id="deleteBtn"><i class="fa-solid fa-trash"></i></div>
        </div>
    </div>

    <!-- 批次標籤 Modal -->
    <div class="modal-overlay" id="tagModal">
        <div class="modal-content">
            <div class="modal-title">批次設定標籤</div>
            <input type="text" id="tagInput" class="modal-input" placeholder="輸入標籤，用空格分隔">
            <button class="modal-btn" id="confirmTag">設定</button>
        </div>
    </div>

    <!-- 搬移相簿 Modal -->
    <div class="modal-overlay" id="moveModal">
        <div class="modal-content">
            <div class="modal-title">搬移至相簿</div>
            <div class="move-list" id="albumMoveList"></div>
            <button class="modal-btn" onclick="document.getElementById('moveModal').style.display='none'">取消</button>
        </div>
    </div>

    <script>
        const allPhotos = JSON.parse(localStorage.getItem('all_photos')) || [];
        const urlParams = new URLSearchParams(window.location.search);
        const currentAlbum = urlParams.get('album') || 'default';
        let selectedPhotos = [];
        let editMode = false;

        document.getElementById('albumName').textContent = currentAlbum;

        function renderPhotos() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';

            let photos = allPhotos.filter(p => {
                if (currentAlbum === 'default') {
                    return !p.restaurant && !p.customAlbum;
                }
                return p.restaurant === currentAlbum || p.customAlbum === currentAlbum;
            });

            photos.sort((a, b) => b.id - a.id);

            if (photos.length === 0) {
                grid.innerHTML = '<div class="empty-album">此相簿暫無照片</div>';
                return;
            }

            photos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.src}" class="photo-img">
                    <div class="selection-overlay"></div>
                `;
                item.onclick = (e) => {
                    e.stopPropagation();
                    if (editMode) {
                        item.classList.toggle('selected');
                        updateSelection();
                    }
                };
                grid.appendChild(item);
            });
        }

        function updateSelection() {
            const selectedItems = document.querySelectorAll('.photo-item.selected');
            selectedPhotos = Array.from(selectedItems).map(item => {
                const src = item.querySelector('img').src;
                return allPhotos.find(p => p.src === src);
            });

            const count = selectedPhotos.length;
            document.getElementById('selectedText').textContent = `已選取 ${count} 張照片`;
            document.getElementById('bottomNav').style.display = count > 0 ? 'flex' : 'none';

            // 更新數字編號
            selectedItems.forEach((el, i) => {
                el.querySelector('.selection-overlay').textContent = i + 1;
            });
        }

        // 選取模式切換
        document.getElementById('selectBtn').onclick = () => {
            editMode = !editMode;
            document.getElementById('selectBtn').textContent = editMode ? '取消' : '選取';
            if (!editMode) {
                document.querySelectorAll('.photo-item').forEach(item => item.classList.remove('selected'));
                updateSelection();
            }
        };

        // 批次標籤
        document.getElementById('tagBtn').onclick = () => {
            document.getElementById('tagModal').style.display = 'flex';
        };
        document.getElementById('confirmTag').onclick = () => {
            const tags = document.getElementById('tagInput').value.trim().split(/\s+/);
            if (tags.length === 0 || tags[0] === '') return;

            selectedPhotos.forEach(photo => {
                if (!photo.tags) photo.tags = [];
                tags.forEach(tag => {
                    if (!photo.tags.includes(tag)) photo.tags.push(tag);
                });
            });

            localStorage.setItem('all_photos', JSON.stringify(allPhotos));
            document.getElementById('tagModal').style.display = 'none';
            document.getElementById('tagInput').value = '';
        };

        // 搬移相簿
        document.getElementById('moveBtn').onclick = () => {
            const list = document.getElementById('albumMoveList');
            list.innerHTML = '';

            // 所有可用相簿
            const albums = ['default'];
            const restaurants = [...new Set(allPhotos.map(p => p.restaurant).filter(Boolean))];
            const customs = JSON.parse(localStorage.getItem('custom_albums')) || [];
            const allAlbums = [...albums, ...restaurants, ...customs];

            allAlbums.forEach(name => {
                if (name === currentAlbum) return; // 不能搬到自己
                const item = document.createElement('div');
                item.className = 'move-item';
                item.textContent = name;
                item.onclick = () => {
                    selectedPhotos.forEach(photo => {
                        // 清除舊分類
                        delete photo.restaurant;
                        delete photo.customAlbum;
                        // 設定新分類
                        if (name !== 'default') {
                            photo.customAlbum = name;
                        }
                    });
                    localStorage.setItem('all_photos', JSON.stringify(allPhotos));
                    renderPhotos();
                    editMode = false;
                    document.getElementById('selectBtn').textContent = '選取';
                    updateSelection();
                    document.getElementById('moveModal').style.display = 'none';
                };
                list.appendChild(item);
            });

            document.getElementById('moveModal').style.display = 'flex';
        };

        // 刪除
        document.getElementById('deleteBtn').onclick = () => {
            if (selectedPhotos.length === 0) return;
            if (confirm(`確定刪除 ${selectedPhotos.length} 張照片？此動作無法復原！`)) {
                const remaining = allPhotos.filter(p => !selectedPhotos.includes(p));
                localStorage.setItem('all_photos', JSON.stringify(remaining));
                renderPhotos();
                editMode = false;
                document.getElementById('selectBtn').textContent = '選取';
                updateSelection();
            }
        };

        // 點擊空白關閉 modal
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.style.display = 'none';
            };
        });

        renderPhotos();
    </script>
</body>
</html>
